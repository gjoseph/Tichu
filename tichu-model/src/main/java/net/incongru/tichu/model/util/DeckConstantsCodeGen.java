package net.incongru.tichu.model.util;

import java.io.IOException;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.time.Instant;
import java.util.Set;
import java.util.TreeSet;
import net.incongru.tichu.model.Card;
import net.incongru.tichu.model.CardDeck;

public class DeckConstantsCodeGen {

    // Generates code for DeckConstants
    public static void main(String[] args) throws IOException {
        // CardDeck shuffles, so we force order the cards here.
        final Set<Card> cards = new TreeSet<>(Card.Comparators.BY_SUIT);
        final CardDeck deck = new CardDeck();
        cards.addAll(deck.allRemaining());

        replaceCodeGenSectionInFile(
            Path.of(
                "tichu-model/src/main/java/net/incongru/tichu/model/util/DeckConstants.java"
            ),
            generateJavaConstants(cards)
        );

        replaceCodeGenSectionInFile(
            Path.of("tichu-clients/packages/tichu-client-ts-lib/src/cards.ts"),
            generateTypescriptConstants(cards)
        );
    }

    private static void replaceCodeGenSectionInFile(
        Path srcPath,
        String newSourceCode
    ) throws IOException {
        final String oldSourceCode = Files.readString(srcPath);
        System.out.println(
            "Loaded " + srcPath + "(" + oldSourceCode.length() + " chars)"
        );
        final String newSrc = oldSourceCode.replaceFirst(
            "(?s)(?m)// ==== Start CodeGen(.*)// ==== End CodeGen",
            newSourceCode.trim()
        );
        Files.writeString(srcPath, newSrc, StandardCharsets.UTF_8);
        System.out.println(
            "Written " + srcPath + "(" + newSrc.length() + " chars)"
        );
    }

    private static String generateJavaConstants(Set<Card> cards) {
        final StringWriter stringWriter = new StringWriter();
        final PrintWriter out = new PrintWriter(stringWriter);
        out.println();
        out.println(
            "    // ==== Start CodeGen -- this was generated by %s on %s".formatted(
                    DeckConstantsCodeGen.class,
                    Instant.now()
                )
        );
        out.println("    // prettier-ignore");
        out.println("    public static final Card");
        for (Card card : cards) {
            final String constName;
            final String constVal;
            if (card.val().isSpecial()) {
                constName = card.val().niceName();
                constVal = " = new Card(Card.CardSpecials." + card.val() + ");";
            } else {
                constName = card.suit() + "_" + card.val().niceName();
                constVal =
                    " = new Card(Card.CardNumbers." +
                    card.val() +
                    ", Card.CardSuit." +
                    card.suit() +
                    ");";
            }
            final String shortAlias = card.shortName().replace('*', '_');
            out.println(
                "            %s = %s,".formatted(shortAlias, constName)
            );

            // "10" cards have a 2-char shortnames like others, but we also want a nice constant
            if (card.val().shortName() == '0') {
                out.println(
                    prefix +
                    card.shortName().replace("0", "10") +
                    " = " +
                    constName +
                    ";"
                );
            }

            // alt. name for Dog
            if (card.val() == Card.CardSpecials.Dog) {
                out.println(prefix + "Hound = Dog;");
            }
        }
        // alt. name for Dog
        out.println("            Hound = Dog;");
        out.println("    // ==== End CodeGen");
        out.println();

        return stringWriter.toString();
    }

    private static String generateTypescriptConstants(Set<Card> cards) {
        final StringWriter stringWriter = new StringWriter();
        final PrintWriter out = new PrintWriter(stringWriter);
        out.println(
            "// ==== Start CodeGen -- this was generated by %s on %s".formatted(
                    DeckConstantsCodeGen.class,
                    Instant.now()
                )
        );
        out.println("export const AllCards: Array<Card> = [");
        cards.forEach(card -> {
            final boolean special = card.val().isSpecial();
            out
                .append("    {\n")
                .append("        name: \"")
                .append(card.name())
                .append("\",\n")
                .append("        shortName: \"")
                .append(card.shortName())
                .append("\",\n")
                .append("        scoreValue: ")
                .append(String.valueOf(card.val().scoreValue()))
                .append(",\n");
            if (special) {
                out.println(
                    "    special: SpecialCards.%s,".formatted(card.name())
                );
            } else {
                out
                    .append("        suit: CardSuit.")
                    .append(card.suit().name())
                    .append(",\n");
                out
                    .append("        number: ")
                    .append(String.valueOf(card.val().playOrder()))
                    .append(",\n");
            }
            out.print(
                """
                    type: "%s",
                  },
                """.formatted(special ? "special" : "normal")
            ); // no idea why this text-block doesn't need indent()
        });
        out.println("];");
        out.println("// ==== End CodeGen");

        return stringWriter.toString();
    }
}
